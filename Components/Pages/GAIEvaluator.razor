@page "/gai-evaluator"
@using PromptAgent.Models
@using PromptAgent.Services
@using Blazored.LocalStorage
@inject GAIEvaluatorService EvaluatorService
@inject ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>GAI å¯è¡Œæ€§è©•ä¼° - PromptAgent</PageTitle>

<div class="evaluator-container">
    <div class="page-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ“Š</span>
            <span class="gradient-text">GAI</span> å¯è¡Œæ€§è©•ä¼°
        </h1>
        <p class="page-subtitle">
            åˆ†æä½ çš„éœ€æ±‚é©åˆä½¿ç”¨ GAIã€å‚³çµ±ç¨‹å¼ã€é‚„æ˜¯äººå·¥è™•ç†
        </p>
        <button class="history-btn" @onclick="ToggleHistory">
            ğŸ“œ æ­·å²ç´€éŒ„ (@historyCount)
        </button>
    </div>

    <!-- è¼¸å…¥è¡¨å–® -->
    <div class="input-section">
        <div class="form-card">
            <div class="form-group">
                <label class="form-label">ğŸ“ æè¿°ä½ çš„éœ€æ±‚</label>
                <textarea class="form-textarea" 
                          @bind="request.RequirementDescription" 
                          placeholder="æè¿°ä½ æƒ³è¦è‡ªå‹•åŒ–çš„ä»»å‹™..."
                          rows="4"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ğŸ“ˆ æ¯æœˆä½¿ç”¨æ¬¡æ•¸</label>
                    <input type="number" class="form-input" @bind="request.MonthlyUsage" min="1" />
                </div>
            </div>
            
            <button class="btn-analyze" @onclick="StartAnalysis" disabled="@isAnalyzing">
                @if (isAnalyzing)
                {
                    <span class="spinner"></span>
                    <span>åˆ†æä¸­...</span>
                }
                else
                {
                    <span class="btn-icon">ğŸ”</span>
                    <span>é–‹å§‹åˆ†æ</span>
                }
            </button>
        </div>
    </div>

    <!-- çµæœå€åŸŸ -->
    @if (result != null)
    {
        <!-- Token ä½¿ç”¨é‡èˆ‡æˆæœ¬ -->
        <div class="token-info-card">
            <h3>ğŸ“Š æ­¤æ¬¡è©•ä¼°çš„ AI æˆæœ¬</h3>
            <div class="token-stats">
                <div class="token-stat">
                    <span class="stat-label">Prompt Tokens</span>
                    <span class="stat-value">@result.EstimatedPromptTokens.ToString("N0")</span>
                </div>
                <div class="token-stat">
                    <span class="stat-label">Response Tokens</span>
                    <span class="stat-value">@result.EstimatedResponseTokens.ToString("N0")</span>
                </div>
                <div class="token-stat">
                    <span class="stat-label">ç¸½è¨ˆ Tokens</span>
                    <span class="stat-value total">@result.TotalTokens.ToString("N0")</span>
                </div>
                <div class="token-stat cost">
                    <span class="stat-label">é ä¼°æˆæœ¬</span>
                    <span class="stat-value">$@result.EstimatedCostUsd.ToString("F4") USD / NT$@result.EstimatedCostTwd.ToString("F2")</span>
                </div>
            </div>
        </div>

        <!-- æ–¹æ¡ˆå¡ç‰‡ -->
        <div class="solutions-section">
            <h2 class="section-title">ğŸ’¡ æ–¹æ¡ˆæ¯”è¼ƒ</h2>
            <div class="solutions-grid">
                @foreach (var solution in result.Solutions)
                {
                    <div class="solution-card @(solution.IsRecommended ? "recommended" : "")">
                        @if (solution.IsRecommended)
                        {
                            <div class="recommended-badge">æ¨è–¦</div>
                        }
                        <div class="solution-icon">@solution.Icon</div>
                        <h3 class="solution-name">@solution.DisplayName</h3>
                        <div class="solution-stars">
                            @for (int i = 0; i < 5; i++)
                            {
                                <span class="star @(i < solution.RecommendationScore ? "filled" : "")">â­</span>
                            }
                        </div>
                        <p class="solution-desc">@solution.Description</p>
                        
                        <div class="solution-details">
                            <div class="detail-item">
                                <span class="detail-label">åˆæœŸæˆæœ¬</span>
                                <span class="detail-value">NT$@solution.SetupCost.ToString("N0")</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ¯æ¬¡æˆæœ¬</span>
                                <span class="detail-value">NT$@solution.CostPerUnit.ToString("N2")</span>
                            </div>
                        </div>
                        
                        <div class="pros-cons">
                            <div class="pros">
                                <h4>âœ… å„ªé»</h4>
                                <ul>
                                    @foreach (var pro in solution.Pros.Take(3))
                                    {
                                        <li>@pro</li>
                                    }
                                </ul>
                            </div>
                            <div class="cons">
                                <h4>âŒ ç¼ºé»</h4>
                                <ul>
                                    @foreach (var con in solution.Cons.Take(3))
                                    {
                                        <li>@con</li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">ğŸ“ˆ æˆæœ¬æ›²ç·šåœ– (NT$)</h3>
                <div class="chart-wrapper">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">ğŸ•¸ï¸ å¤šç¶­åº¦æ¯”è¼ƒ</h3>
                <div class="chart-wrapper">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI çµè«– -->
        <div class="conclusion-section">
            <div class="conclusion-card">
                <div class="conclusion-header">
                    <span class="conclusion-icon">ğŸ’¡</span>
                    <h3>AI åˆ†æçµè«–</h3>
                </div>
                <p class="conclusion-text">@result.AiConclusion</p>
                @if (!string.IsNullOrEmpty(result.TraditionalAlternative) && result.TraditionalAlternative != "è¦–éœ€æ±‚è€Œå®š")
                {
                    <div class="alternative-suggestion">
                        <span class="suggestion-icon">ğŸ”§</span>
                        <span>å‚³çµ±ç¨‹å¼å»ºè­°å·¥å…·ï¼š<strong>@result.TraditionalAlternative</strong></span>
                    </div>
                }
            </div>
        </div>
        
        <!-- å°ˆæ¥­ç¨‹å¼ç¢¼å»ºè­° (Codex) -->
        @if (result.CodeSuggestion != null)
        {
            <div class="code-suggestion-section">
                <div class="code-card">
                    <div class="code-header">
                        <span class="code-icon">ğŸ‘¨â€ğŸ’»</span>
                        <h3>å°ˆæ¥­ç¨‹å¼ç¢¼å»ºè­°</h3>
                        <span class="codex-badge">Codex ç”Ÿæˆ</span>
                    </div>
                    
                    <div class="code-meta">
                        <div class="meta-item">
                            <span class="meta-label">æŠ€è¡“æ£§</span>
                            <span class="meta-value">@result.CodeSuggestion.TechStack</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">é›£åº¦</span>
                            <span class="meta-value difficulty-@result.CodeSuggestion.DifficultyLevel">
                                @for (int i = 0; i < result.CodeSuggestion.DifficultyLevel; i++) { <span>â­</span> }
                            </span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">é ä¼°å·¥æ™‚</span>
                            <span class="meta-value">@result.CodeSuggestion.EstimatedHours å°æ™‚</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">é ä¼°æˆæœ¬</span>
                            <span class="meta-value">NT$@((result.CodeSuggestion.EstimatedHours * 269).ToString("N0"))</span>
                        </div>
                    </div>
                    
                    @if (result.CodeSuggestion.Libraries.Count > 0)
                    {
                        <div class="libraries-section">
                            <h4>ğŸ“¦ å»ºè­°å¥—ä»¶</h4>
                            <div class="library-tags">
                                @foreach (var lib in result.CodeSuggestion.Libraries)
                                {
                                    <span class="library-tag">@lib</span>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (result.CodeSuggestion.ImplementationSteps.Count > 0)
                    {
                        <div class="steps-section">
                            <h4>ğŸ“‹ å¯¦ä½œæ­¥é©Ÿ</h4>
                            <ol class="implementation-steps">
                                @foreach (var step in result.CodeSuggestion.ImplementationSteps)
                                {
                                    <li>@step</li>
                                }
                            </ol>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(result.CodeSuggestion.SampleCode))
                    {
                        <div class="sample-code-section">
                            <h4>ğŸ’» ç¯„ä¾‹ç¨‹å¼ç¢¼</h4>
                            <pre class="sample-code"><code>@result.CodeSuggestion.SampleCode</code></pre>
                        </div>
                    }
                    
                    @if (result.CodeSuggestion.Caveats.Count > 0)
                    {
                        <div class="caveats-section">
                            <h4>âš ï¸ æ³¨æ„äº‹é …</h4>
                            <ul class="caveats-list">
                                @foreach (var caveat in result.CodeSuggestion.Caveats)
                                {
                                    <li>@caveat</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@* æ­·å²ç´€éŒ„ Modal *@
@if (showHistory)
{
    <div class="modal-overlay" @onclick="ToggleHistory">
        <div class="history-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>ğŸ“œ è©•ä¼°æ­·å²ç´€éŒ„</h3>
                <button class="close-btn" @onclick="ToggleHistory">âœ•</button>
            </div>
            <div class="modal-body">
                @if (history.Count == 0)
                {
                    <p class="no-history">é‚„æ²’æœ‰ä»»ä½•è©•ä¼°ç´€éŒ„</p>
                }
                else
                {
                    <div class="history-list">
                        @foreach (var item in history)
                        {
                            <div class="history-item" @onclick="() => LoadFromHistory(item)">
                                <div class="history-date">@item.EvaluatedAt.ToString("MM/dd HH:mm")</div>
                                <div class="history-desc">@(item.RequirementDescription.Length > 50 ? item.RequirementDescription[..50] + "..." : item.RequirementDescription)</div>
                                <div class="history-meta">
                                    <span class="history-recommendation">æ¨è–¦: @item.RecommendedSolution</span>
                                    <span class="history-tokens">@item.TotalTokens tokens</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="clear-btn" @onclick="ClearHistory">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
            </div>
        </div>
    </div>
}

@code {
    private EvaluationRequest request = new()
    {
        RequirementDescription = "",
        MonthlyUsage = 10000
    };
    
    // ç¯„ä¾‹éœ€æ±‚
    private readonly string[] exampleRequirements = new[]
    {
        "è¾¨è­˜å›ºå®šæ ¼å¼çš„ç°¡å–®æ•¸å­—é©—è­‰ç¢¼ï¼Œ4 ä½ç´”æ•¸å­—ï¼Œç™½åº•é»‘å­—ç„¡å¹²æ“¾ç·š",
        "é©—è­‰ä½¿ç”¨è€…è¼¸å…¥çš„ Email æ ¼å¼æ˜¯å¦æ­£ç¢º",
        "å¾ PDF æ ¼å¼çš„ç™¼ç¥¨ä¸­æ“·å–ç™¼ç¥¨è™Ÿç¢¼ã€æ—¥æœŸã€é‡‘é¡ç­‰æ¬„ä½",
        "å°‡å®¢æœå°è©±å…§å®¹è‡ªå‹•åˆ†é¡ç‚ºã€Œè©¢å•ã€ã€ŒæŠ•è¨´ã€ã€Œè®šç¾ã€ã€Œå…¶ä»–ã€",
        "å°‡æ—¥æœŸå­—ä¸²å¾å„ç¨®æ ¼å¼ï¼ˆå¦‚ 2024/1/1ã€Jan 1, 2024ã€1-1-24ï¼‰çµ±ä¸€è½‰æ›ç‚º ISO æ ¼å¼"
    };

    private EvaluationResult? result;
    private bool isAnalyzing = false;
    
    // æ­·å²ç´€éŒ„ç›¸é—œ
    private const string HISTORY_KEY = "gai_evaluation_history";
    private const int MAX_HISTORY = 20;
    private List<EvaluationResult> history = new();
    private int historyCount = 0;
    private bool showHistory = false;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadHistoryCount();
            StateHasChanged();
        }
    }
    
    private void SetExample(int index)
    {
        if (index >= 0 && index < exampleRequirements.Length)
        {
            request.RequirementDescription = exampleRequirements[index];
            StateHasChanged();
        }
    }
    
    private async Task LoadHistoryCount()
    {
        try
        {
            var items = await LocalStorage.GetItemAsync<List<EvaluationResult>>(HISTORY_KEY);
            historyCount = items?.Count ?? 0;
        }
        catch { historyCount = 0; }
    }
    
    private async Task SaveToHistory(EvaluationResult item)
    {
        try
        {
            var items = await LocalStorage.GetItemAsync<List<EvaluationResult>>(HISTORY_KEY) ?? new();
            items.Insert(0, item); // æœ€æ–°çš„åœ¨å‰é¢
            if (items.Count > MAX_HISTORY) items = items.Take(MAX_HISTORY).ToList();
            await LocalStorage.SetItemAsync(HISTORY_KEY, items);
            historyCount = items.Count;
        }
        catch { /* Ignore */ }
    }
    
    private async Task ToggleHistory()
    {
        showHistory = !showHistory;
        if (showHistory)
        {
            history = await LocalStorage.GetItemAsync<List<EvaluationResult>>(HISTORY_KEY) ?? new();
        }
    }
    
    private void LoadFromHistory(EvaluationResult item)
    {
        result = item;
        request.RequirementDescription = item.RequirementDescription;
        showHistory = false;
        StateHasChanged();
    }
    
    private async Task ClearHistory()
    {
        await LocalStorage.RemoveItemAsync(HISTORY_KEY);
        history.Clear();
        historyCount = 0;
        showHistory = false;
    }

    private async Task StartAnalysis()
    {
        if (string.IsNullOrWhiteSpace(request.RequirementDescription))
        {
            return;
        }

        isAnalyzing = true;
        StateHasChanged();

        try
        {
            result = await EvaluatorService.EvaluateRequirementAsync(request);
            
            // å„²å­˜åˆ°æ­·å²ç´€éŒ„
            await SaveToHistory(result);
            
            StateHasChanged();
            
            // ç­‰å¾… DOM æ›´æ–°å¾Œæ¸²æŸ“åœ–è¡¨
            await Task.Delay(100);
            await RenderCharts();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Analysis failed: {ex.Message}");
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private async Task RenderCharts()
    {
        if (result == null) return;

        // æˆæœ¬æ›²ç·šåœ–è³‡æ–™
        var usagePoints = new[] { 0, 1000, 5000, 10000, 25000, 50000 };
        var costData = new
        {
            labels = usagePoints.Select(u => u.ToString("N0")).ToArray(),
            datasets = result.Solutions.Select(s => new
            {
                label = s.DisplayName,
                data = usagePoints.Select(u => (double)(s.SetupCost + s.CostPerUnit * u)).ToArray()
            }).ToArray()
        };

        await JSRuntime.InvokeVoidAsync("chartInterop.createLineChart", "costChart", costData);

        // é›·é”åœ–è³‡æ–™
        var radarData = new
        {
            labels = new[] { "é–‹ç™¼é€Ÿåº¦", "æº–ç¢ºåº¦", "ç¶­è­·æˆæœ¬", "æ“´å±•æ€§", "éˆæ´»æ€§" },
            datasets = result.Solutions.Select(s => new
            {
                label = s.DisplayName,
                data = new[] { s.DevelopmentSpeed, s.Accuracy, s.MaintenanceCost, s.Scalability, s.Flexibility }
            }).ToArray()
        };

        await JSRuntime.InvokeVoidAsync("chartInterop.createRadarChart", "radarChart", radarData);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("chartInterop.destroyChart", "costChart");
            await JSRuntime.InvokeVoidAsync("chartInterop.destroyChart", "radarChart");
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
