@page "/prompt-versions"
@using PromptAgent.Models
@using PromptAgent.Services
@inject PromptVersionService VersionService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Prompt ç‰ˆæœ¬æ§åˆ¶ - PromptAgent</PageTitle>

<div class="versions-container">
    <header class="page-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ“š</span>
            Prompt ç‰ˆæœ¬æ§åˆ¶
        </h1>
        <button class="btn-new-project" @onclick="ShowNewProjectDialog">
            â• æ–°å°ˆæ¡ˆ
        </button>
    </header>

    @if (isLoading)
    {
        <div class="loading">è¼‰å…¥ä¸­...</div>
    }
    else if (selectedProject == null)
    {
        <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
        <div class="projects-section">
            <h2 class="section-title">æˆ‘çš„å°ˆæ¡ˆ</h2>
            
            @if (projects.Count == 0)
            {
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‚</div>
                    <p>é‚„æ²’æœ‰ä»»ä½•å°ˆæ¡ˆ</p>
                    <p class="empty-hint">å»ºç«‹ä¸€å€‹å°ˆæ¡ˆä¾†é–‹å§‹ç®¡ç†ä½ çš„ Prompt ç‰ˆæœ¬</p>
                </div>
            }
            else
            {
                <div class="projects-grid">
                    @foreach (var project in projects)
                    {
                        <div class="project-card" @onclick="() => SelectProject(project)">
                            <div class="project-icon">ğŸ—‚ï¸</div>
                            <div class="project-info">
                                <h3 class="project-name">@project.Name</h3>
                                <p class="project-meta">
                                    @project.VersionCount å€‹ç‰ˆæœ¬ Â· 
                                    @project.UpdatedAt.ToString("MM/dd HH:mm")
                                </p>
                            </div>
                            <button class="btn-delete" @onclick:stopPropagation="true" @onclick="() => DeleteProject(project)">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <!-- å°ˆæ¡ˆè©³æƒ… -->
        <div class="project-detail">
            <div class="detail-header">
                <button class="btn-back" @onclick="() => selectedProject = null">
                    â† è¿”å›
                </button>
                <h2 class="detail-title">@selectedProject.Name</h2>
                <div class="header-actions">
                    <button class="btn-action" @onclick="SaveNewVersion">
                        ğŸ’¾ å„²å­˜æ–°ç‰ˆæœ¬
                    </button>
                    <button class="btn-action secondary" @onclick="GoToTest">
                        ğŸ§ª å‰å¾€æ¸¬è©¦
                    </button>
                </div>
            </div>

            <!-- ç•¶å‰ç·¨è¼¯çš„ Prompt -->
            <div class="editor-section">
                <div class="editor-card">
                    <h3>System Prompt</h3>
                    <textarea class="editor-input" @bind="editSystemPrompt" rows="6" 
                        placeholder="è¼¸å…¥ System Prompt..."></textarea>
                </div>
                <div class="editor-card">
                    <h3>Question</h3>
                    <textarea class="editor-input" @bind="editQuestion" rows="3"
                        placeholder="è¼¸å…¥æ¸¬è©¦å•é¡Œ..."></textarea>
                </div>
                <div class="editor-card">
                    <h3>Expected Answer</h3>
                    <textarea class="editor-input" @bind="editExpectedAnswer" rows="3"
                        placeholder="è¼¸å…¥é æœŸç­”æ¡ˆ..."></textarea>
                </div>
            </div>

            <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
            <div class="versions-section">
                <h3 class="section-subtitle">ç‰ˆæœ¬æ­·å²</h3>
                
                @if (versions.Count == 0)
                {
                    <p class="no-versions">é‚„æ²’æœ‰ä»»ä½•ç‰ˆæœ¬ï¼Œå„²å­˜ç¬¬ä¸€å€‹ç‰ˆæœ¬å§ï¼</p>
                }
                else
                {
                    <div class="versions-list">
                        @foreach (var version in versions)
                        {
                            <div class="version-item @(version.Id == selectedProject.CurrentVersionId ? "current" : "")">
                                <div class="version-header">
                                    <span class="version-number">v@(version.VersionNumber)</span>
                                    @if (version.IsBest)
                                    {
                                        <span class="tag best">â­ best</span>
                                    }
                                    @if (version.IsProduction)
                                    {
                                        <span class="tag production">ğŸš€ production</span>
                                    }
                                    <span class="version-date">@version.CreatedAt.ToString("MM/dd HH:mm")</span>
                                </div>
                                
                                <div class="version-scores">
                                    @if (version.StabilityScore.HasValue)
                                    {
                                        <span class="score stability">ç©©å®šæ€§: @version.StabilityScore</span>
                                    }
                                    @if (version.CorrectnessScore.HasValue)
                                    {
                                        <span class="score correctness">æ­£ç¢ºæ€§: @version.CorrectnessScore</span>
                                    }
                                </div>
                                
                                @if (!string.IsNullOrEmpty(version.Note))
                                {
                                    <div class="version-note">ğŸ“ @version.Note</div>
                                }
                                
                                <div class="version-actions">
                                    <button class="btn-small" @onclick="() => LoadVersion(version)">è¼‰å…¥</button>
                                    <button class="btn-small" @onclick="() => ToggleBest(version)">
                                        @(version.IsBest ? "å–æ¶ˆ Best" : "æ¨™è¨˜ Best")
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@* æ–°å°ˆæ¡ˆ Modal - ä½¿ç”¨ inline styles ç¢ºä¿é¡¯ç¤º *@
@if (showNewProjectDialog)
{
    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px);" @onclick="() => showNewProjectDialog = false">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 16px; padding: 2rem; width: 90%; max-width: 400px; border: 1px solid rgba(102, 126, 234, 0.5); box-shadow: 0 25px 50px rgba(0,0,0,0.5);" @onclick:stopPropagation="true">
            <h3 style="color: #fff; margin: 0 0 1.5rem 0; font-size: 1.25rem;">å»ºç«‹æ–°å°ˆæ¡ˆ</h3>
            <input type="text" @bind="newProjectName" 
                style="width: 100%; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 0.75rem 1rem; color: #fff; font-size: 1rem; margin-bottom: 1.5rem; box-sizing: border-box;"
                placeholder="å°ˆæ¡ˆåç¨±..." @onkeyup="HandleNewProjectKeyUp" />
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 0.6rem 1.25rem; border-radius: 8px; cursor: pointer;" @onclick="() => showNewProjectDialog = false">å–æ¶ˆ</button>
                <button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 0.6rem 1.25rem; border-radius: 8px; cursor: pointer;" @onclick="CreateProject">å»ºç«‹</button>
            </div>
        </div>
    </div>
}

@code {
    private List<PromptProject> projects = new();
    private PromptProject? selectedProject;
    private List<PromptVersion> versions = new();
    private bool isLoading = true;
    
    // æ–°å°ˆæ¡ˆ
    private bool showNewProjectDialog;
    private string newProjectName = "";
    
    // ç·¨è¼¯å™¨
    private string editSystemPrompt = "";
    private string editQuestion = "";
    private string editExpectedAnswer = "";
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProjects();
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadProjects()
    {
        projects = await VersionService.GetProjectsAsync();
    }
    
    private void ShowNewProjectDialog()
    {
        newProjectName = "";
        showNewProjectDialog = true;
    }
    
    private async Task HandleNewProjectKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await CreateProject();
    }
    
    private async Task CreateProject()
    {
        if (string.IsNullOrWhiteSpace(newProjectName)) return;
        
        var project = await VersionService.CreateProjectAsync(newProjectName);
        projects.Insert(0, project);
        showNewProjectDialog = false;
        
        // ç›´æ¥é€²å…¥æ–°å°ˆæ¡ˆ
        await SelectProject(project);
    }
    
    private async Task SelectProject(PromptProject project)
    {
        selectedProject = project;
        versions = await VersionService.GetVersionsAsync(project.Id);
        
        // è¼‰å…¥æœ€æ–°ç‰ˆæœ¬åˆ°ç·¨è¼¯å™¨
        var latest = versions.FirstOrDefault();
        if (latest != null)
        {
            editSystemPrompt = latest.SystemPrompt;
            editQuestion = latest.Question;
            editExpectedAnswer = latest.ExpectedAnswer;
        }
        else
        {
            editSystemPrompt = "";
            editQuestion = "";
            editExpectedAnswer = "";
        }
    }
    
    private async Task DeleteProject(PromptProject project)
    {
        await VersionService.DeleteProjectAsync(project.Id);
        projects.Remove(project);
    }
    
    private async Task SaveNewVersion()
    {
        if (selectedProject == null) return;
        
        var version = await VersionService.SaveVersionAsync(
            selectedProject.Id,
            editSystemPrompt,
            editQuestion,
            editExpectedAnswer);
        
        versions.Insert(0, version);
        selectedProject.CurrentVersionId = version.Id;
        selectedProject.VersionCount = versions.Count;
    }
    
    private void LoadVersion(PromptVersion version)
    {
        editSystemPrompt = version.SystemPrompt;
        editQuestion = version.Question;
        editExpectedAnswer = version.ExpectedAnswer;
    }
    
    private async Task ToggleBest(PromptVersion version)
    {
        var newTags = version.Tags.ToList();
        if (version.IsBest)
        {
            newTags.Remove("best");
        }
        else
        {
            newTags.Add("best");
        }
        
        await VersionService.UpdateVersionTagsAsync(selectedProject!.Id, version.Id, newTags);
        versions = await VersionService.GetVersionsAsync(selectedProject.Id);
    }
    
    private void GoToTest()
    {
        // å°èˆªåˆ°æ¸¬è©¦é é¢ï¼ˆä¹‹å¾Œå¯ä»¥å¸¶åƒæ•¸ï¼‰
        Navigation.NavigateTo("/prompt-test");
    }
}
