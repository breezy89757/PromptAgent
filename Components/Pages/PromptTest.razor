@page "/prompt-test"
@using PromptAgent.Models
@using PromptAgent.Services
@inject AgentService AgentService
@inject EvaluationService EvaluationService
@rendermode InteractiveServer

<PageTitle>Prompt Test - PromptAgent</PageTitle>

<div class="test-page">
    <header class="page-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ§ª</span>
            Prompt å„ªåŒ–æ¸¬è©¦
        </h1>
    </header>

    <div class="test-grid">
        <!-- å·¦å´: è¼¸å…¥å€åŸŸ -->
        <div>
            <div class="test-card">
                <div class="card-header card-header-primary">
                    <h2 class="card-title">
                        <span>âœï¸</span>
                        æ¸¬è©¦é…ç½®
                    </h2>
                    <div class="dropdown">
                        <button class="dropdown-btn dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            âš¡ è¼‰å…¥ç¯„ä¾‹
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">é¸æ“‡é è¨­æ¸¬è©¦ç¯„ä¾‹</h6></li>
                            <li><button class="dropdown-item" type="button" @onclick="() => LoadExample(0)">ğŸ“ æ•¸å­¸é‹ç®—</button></li>
                            <li><button class="dropdown-item" type="button" @onclick="() => LoadExample(1)">ğŸ§  é‚è¼¯æ¨ç†</button></li>
                            <li><button class="dropdown-item" type="button" @onclick="() => LoadExample(2)">ğŸŒ ç¿»è­¯ä»»å‹™</button></li>
                            <li><button class="dropdown-item" type="button" @onclick="() => LoadExample(3)">ğŸ“ æ–‡å­—æ‘˜è¦</button></li>
                            <li><button class="dropdown-item" type="button" @onclick="() => LoadExample(4)">ğŸ’» ç¨‹å¼ç¢¼ç”Ÿæˆ</button></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">System Prompt (Instructions)</label>
                        <textarea class="form-control"
                                  rows="6"
                                  placeholder="è¼¸å…¥ç³»çµ±æç¤ºè©ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ç¿»è­¯åŠ©æ‰‹..."
                                  @bind="testCase.SystemPrompt"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸¬è©¦å•é¡Œ</label>
                        <textarea class="form-control"
                                  rows="3"
                                  placeholder="è¼¸å…¥è¦æ¸¬è©¦çš„å•é¡Œ..."
                                  @bind="testCase.Question"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é æœŸç­”æ¡ˆ</label>
                        <textarea class="form-control"
                                  rows="3"
                                  placeholder="è¼¸å…¥é æœŸçš„ç­”æ¡ˆï¼ˆç”¨æ–¼è©•ä¼°æ­£ç¢ºæ€§ï¼‰..."
                                  @bind="testCase.ExpectedAnswer"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            åŸ·è¡Œæ¬¡æ•¸: <span class="range-value">@testCase.ExecutionCount</span>
                        </label>
                        <div class="range-container">
                            <input type="range"
                                   class="form-range"
                                   min="1"
                                   max="10"
                                   @bind="testCase.ExecutionCount" />
                        </div>
                        <p class="range-hint">åŸ·è¡Œå¤šæ¬¡ä»¥æ¸¬è©¦ç©©å®šæ€§ (å»ºè­° 3-5 æ¬¡)</p>
                    </div>

                    <button class="btn-execute"
                            @onclick="ExecuteTestAsync"
                            disabled="@isExecuting">
                        @if (isExecuting)
                        {
                            <span class="spinner"></span>
                            <span>åŸ·è¡Œä¸­... (@completedCount/@testCase.ExecutionCount)</span>
                        }
                        else
                        {
                            <span>â–¶ï¸</span>
                            <span>é–‹å§‹æ¸¬è©¦</span>
                        }
                    </button>
                </div>
            </div>
        </div>

        <!-- å³å´: çµæœå€åŸŸ -->
        <div>
            @if (testResult != null)
            {
                <!-- è©•åˆ†å¡ç‰‡ -->
                <div class="test-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header card-header-success">
                        <h2 class="card-title">
                            <span>ğŸ“Š</span>
                            è©•ä¼°çµæœ
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="score-grid">
                            <div class="score-item">
                                <div class="score-value @GetScoreClass(testResult.StabilityScore)">
                                    @testResult.StabilityScore
                                </div>
                                <div class="score-label">ç©©å®šæ€§</div>
                                <div class="score-bar">
                                    <div class="score-bar-fill @GetScoreClass(testResult.StabilityScore)"
                                         style="width: @(testResult.StabilityScore)%"></div>
                                </div>
                            </div>
                            <div class="score-item">
                                <div class="score-value @GetScoreClass(testResult.CorrectnessScore)">
                                    @testResult.CorrectnessScore
                                </div>
                                <div class="score-label">æ­£ç¢ºæ€§</div>
                                <div class="score-bar">
                                    <div class="score-bar-fill @GetScoreClass(testResult.CorrectnessScore)"
                                         style="width: @(testResult.CorrectnessScore)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å„ªåŒ–å»ºè­° -->
                @if (testResult.Suggestions.Count > 0)
                {
                    <div class="test-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header card-header-warning">
                            <h2 class="card-title">
                                <span>ğŸ’¡</span>
                                å„ªåŒ–å»ºè­°
                            </h2>
                            @if (!string.IsNullOrEmpty(testResult.OptimizedPrompt))
                            {
                                <button class="btn-accept" @onclick="AcceptSuggestions">
                                    âœ“ ä¸€éµæ¥å—å»ºè­°
                                </button>
                            }
                        </div>
                        <div class="card-body">
                            <ul class="suggestions-list">
                                @foreach (var suggestion in testResult.Suggestions)
                                {
                                    <li class="suggestion-item">@suggestion</li>
                                }
                            </ul>
                            @if (!string.IsNullOrEmpty(testResult.OptimizedPrompt))
                            {
                                <div class="optimized-prompt">
                                    <div class="optimized-label">å»ºè­°çš„å„ªåŒ–å¾Œ Promptï¼š</div>
                                    <div class="report-content">@testResult.OptimizedPrompt</div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- è©³ç´°å ±å‘Š -->
                <div class="test-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header card-header-info">
                        <h2 class="card-title">
                            <span>ğŸ“„</span>
                            è©³ç´°è©•ä¼°å ±å‘Š
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="report-content">@testResult.EvaluationReport</div>
                    </div>
                </div>

                <!-- å„æ¬¡åŸ·è¡Œçµæœ -->
                <div class="test-card">
                    <div class="card-header" style="background: rgba(0,0,0,0.3);">
                        <h2 class="card-title">
                            <span>ğŸ“‹</span>
                            å„æ¬¡åŸ·è¡Œçµæœ
                        </h2>
                    </div>
                    <div class="accordion-container">
                        @foreach (var response in testResult.Responses)
                        {
                            var collapseId = $"response-{response.ExecutionIndex}";
                            <div class="accordion-item">
                                <div class="accordion-header" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                                    <span class="status-badge @(response.IsSuccess ? "success" : "error")">
                                        @(response.IsSuccess ? "æˆåŠŸ" : "å¤±æ•—")
                                    </span>
                                    <span style="margin-left: 0.75rem; flex: 1;">ç¬¬ @response.ExecutionIndex æ¬¡åŸ·è¡Œ</span>
                                    <span style="color: #888; font-size: 0.85rem;">@response.ExecutionTimeMs ms</span>
                                </div>
                                <div id="@collapseId" class="collapse">
                                    <div class="accordion-content">
                                        @if (response.IsSuccess)
                                        {
                                            <div class="response-content">@response.Content</div>
                                        }
                                        else
                                        {
                                            <div style="color: #ef4444;">@response.ErrorMessage</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!isExecuting)
            {
                <!-- ç©ºç‹€æ…‹ -->
                <div class="test-card">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“¥</div>
                        <h3 class="empty-title">å°šç„¡æ¸¬è©¦çµæœ</h3>
                        <p class="empty-hint">
                            å¡«å¯«å·¦å´çš„æ¸¬è©¦é…ç½®ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€æŒ‰éˆ•<br />
                            ğŸ’¡ æç¤ºï¼šé»æ“Šã€Œè¼‰å…¥ç¯„ä¾‹ã€å¿«é€Ÿé–‹å§‹
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private TestCase testCase = new();
    private TestResult? testResult;
    private bool isExecuting;
    private int completedCount;

    // é è¨­æ¸¬è©¦ç¯„ä¾‹
    private static readonly List<TestCase> Examples =
    [
        // æ•¸å­¸é‹ç®—
        new TestCase
        {
            SystemPrompt = "ä½ æ˜¯ä¸€å€‹æ•¸å­¸åŠ©æ•™ï¼Œå›ç­”éœ€åŒ…å«å®Œæ•´çš„è¨ˆç®—éç¨‹ã€‚è«‹ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š\n1. è¨­å®šè®Šæ•¸\n2. åˆ—å‡ºæ–¹ç¨‹å¼\n3. é€æ­¥æ±‚è§£\n4. æœ€çµ‚ç­”æ¡ˆ",
            Question = "å¦‚æœä¸€å€‹æ•¸å­—çš„ä¸‰å€åŠ ä¸Š5ç­‰æ–¼20ï¼Œé€™å€‹æ•¸å­—æ˜¯å¤šå°‘ï¼Ÿ",
            ExpectedAnswer = "è¨­æ•¸å­—ç‚º x\næ–¹ç¨‹å¼ï¼š3x + 5 = 20\nè§£ï¼š3x = 15 â†’ x = 5\nç­”æ¡ˆï¼š5"
        },
        // é‚è¼¯æ¨ç†
        new TestCase
        {
            SystemPrompt = "ä½ æ˜¯ä¸€å€‹é‚è¼¯æ¨ç†å°ˆå®¶ã€‚è«‹åˆ†æå•é¡Œï¼Œåˆ—å‡ºæ‰€æœ‰å·²çŸ¥æ¢ä»¶ï¼Œé€æ­¥æ¨å°ï¼Œä¸¦çµ¦å‡ºæ˜ç¢ºçš„çµè«–ã€‚",
            Question = "å°æ˜æ¯”å°è¯é«˜ï¼Œå°è¯æ¯”å°æé«˜ï¼Œå°ææ¯”å°å¼µé«˜ã€‚è«‹å•èª°æœ€é«˜ï¼Ÿèª°æœ€çŸ®ï¼Ÿ",
            ExpectedAnswer = "å·²çŸ¥æ¢ä»¶ï¼šå°æ˜ > å°è¯ > å°æ > å°å¼µ\nçµè«–ï¼šå°æ˜æœ€é«˜ï¼Œå°å¼µæœ€çŸ®"
        },
        // ç¿»è­¯ä»»å‹™
        new TestCase
        {
            SystemPrompt = "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ç¿»è­¯åŠ©æ‰‹ã€‚è«‹å°‡ä½¿ç”¨è€…è¼¸å…¥çš„å…§å®¹ç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼Œä¿æŒåŸæ–‡çš„èªæ°£å’Œé¢¨æ ¼ã€‚",
            Question = "Please translate: 'The quick brown fox jumps over the lazy dog.'",
            ExpectedAnswer = "æ•æ·çš„æ£•è‰²ç‹ç‹¸è·³éäº†æ‡¶æƒ°çš„ç‹—ã€‚"
        },
        // æ–‡å­—æ‘˜è¦
        new TestCase
        {
            SystemPrompt = "ä½ æ˜¯ä¸€å€‹æ–‡å­—æ‘˜è¦å°ˆå®¶ã€‚è«‹ç”¨3å€‹é‡é»ç¸½çµä½¿ç”¨è€…æä¾›çš„å…§å®¹ï¼Œæ¯å€‹é‡é»ä¸è¶…é20å€‹å­—ã€‚",
            Question = "äººå·¥æ™ºæ…§ï¼ˆAIï¼‰æ˜¯è¨ˆç®—æ©Ÿç§‘å­¸çš„ä¸€å€‹åˆ†æ”¯ï¼Œå®ƒè©¦åœ–ç†è§£æ™ºæ…§çš„å¯¦è³ªï¼Œä¸¦ç”Ÿç”¢å‡ºä¸€ç¨®æ–°çš„èƒ½ä»¥é¡ä¼¼æ–¼äººé¡æ™ºæ…§çš„æ–¹å¼ä½œå‡ºåæ‡‰çš„æ™ºæ…§æ©Ÿå™¨ã€‚è©²é ˜åŸŸçš„ç ”ç©¶åŒ…æ‹¬æ©Ÿå™¨äººã€èªè¨€è­˜åˆ¥ã€åœ–åƒè­˜åˆ¥ã€è‡ªç„¶èªè¨€è™•ç†å’Œå°ˆå®¶ç³»çµ±ç­‰ã€‚",
            ExpectedAnswer = "1. AIæ˜¯è¨ˆç®—æ©Ÿç§‘å­¸çš„åˆ†æ”¯\n2. ç›®æ¨™æ˜¯å‰µé€ é¡äººæ™ºæ…§çš„æ©Ÿå™¨\n3. åŒ…å«æ©Ÿå™¨äººã€èªè¨€è­˜åˆ¥ç­‰é ˜åŸŸ"
        },
        // ç¨‹å¼ç¢¼ç”Ÿæˆ
        new TestCase
        {
            SystemPrompt = "ä½ æ˜¯ä¸€å€‹ç¨‹å¼ç¢¼åŠ©æ‰‹ã€‚è«‹ç”¨ç°¡æ½”çš„ç¨‹å¼ç¢¼è§£æ±ºå•é¡Œï¼Œä¸¦åŠ ä¸Šå¿…è¦çš„è¨»è§£èªªæ˜ã€‚ä½¿ç”¨ Python èªè¨€ã€‚",
            Question = "å¯«ä¸€å€‹å‡½å¼è¨ˆç®—è²»æ°æ•¸åˆ—çš„ç¬¬ n é …",
            ExpectedAnswer = "def fibonacci(n):\n    if n <= 1:\n        return n\n    return fibonacci(n-1) + fibonacci(n-2)"
        }
    ];

    private void LoadExample(int index)
    {
        if (index >= 0 && index < Examples.Count)
        {
            var example = Examples[index];
            testCase.SystemPrompt = example.SystemPrompt;
            testCase.Question = example.Question;
            testCase.ExpectedAnswer = example.ExpectedAnswer;
            testResult = null;
            StateHasChanged();
        }
    }

    private void AcceptSuggestions()
    {
        if (testResult?.OptimizedPrompt != null)
        {
            testCase.SystemPrompt = testResult.OptimizedPrompt;
            StateHasChanged();
        }
    }

    private async Task ExecuteTestAsync()
    {
        if (string.IsNullOrWhiteSpace(testCase.SystemPrompt) ||
            string.IsNullOrWhiteSpace(testCase.Question))
        {
            return;
        }

        isExecuting = true;
        completedCount = 0;
        testResult = null;
        StateHasChanged();

        try
        {
            // å¹³è¡ŒåŸ·è¡Œå¤šå€‹ Agent
            var responses = await AgentService.ExecuteParallelAsync(testCase);
            completedCount = responses.Count;
            StateHasChanged();

            // ä½¿ç”¨è©•ä¼°æœå‹™åˆ†æçµæœ
            testResult = await EvaluationService.EvaluateResultsAsync(testCase, responses);
        }
        catch (Exception ex)
        {
            testResult = new TestResult
            {
                TestCaseId = testCase.Id,
                EvaluationReport = $"åŸ·è¡Œå¤±æ•—: {ex.Message}",
                Suggestions = ["è«‹æª¢æŸ¥ Azure OpenAI é€£ç·šè¨­å®šæ˜¯å¦æ­£ç¢º"]
            };
        }
        finally
        {
            isExecuting = false;
            StateHasChanged();
        }
    }

    private static string GetScoreClass(int score) => score switch
    {
        >= 80 => "success",
        >= 60 => "warning",
        _ => "danger"
    };
}
