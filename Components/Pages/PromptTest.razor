@page "/prompt-test"
@using PromptAgent.Models
@using PromptAgent.Services
@inject AgentService AgentService
@inject EvaluationService EvaluationService
@inject ExampleGeneratorService ExampleGenerator
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Prompt Test - PromptAgent</PageTitle>

<div class="test-page">
    <header class="page-header">
        <h1 class="page-title">
            <span class="title-icon">ğŸ§ª</span>
            Prompt å„ªåŒ–æ¸¬è©¦
        </h1>
    </header>

    <div class="test-grid">
        <!-- å·¦å´: è¼¸å…¥å€åŸŸ -->
        <div>
            <div class="test-card">
                <div class="card-header card-header-primary">
                    <h2 class="card-title">
                        <span>âœï¸</span>
                        æ¸¬è©¦é…ç½®
                    </h2>
                    <div class="dropdown">
                        <button class="dropdown-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" disabled="@isGeneratingExample">
                            @if (isGeneratingExample)
                            {
                                <span class="spinner" style="width: 14px; height: 14px;"></span>
                                <span>ç”Ÿæˆä¸­...</span>
                            }
                            else
                            {
                                <span>âœ¨ AI ç”Ÿæˆç¯„ä¾‹</span>
                            }
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">é¸æ“‡åˆ†é¡ï¼ŒAI éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹</h6></li>
                            @foreach (var category in ExampleGeneratorService.Categories)
                            {
                                <li>
                                    <button class="dropdown-item" type="button" @onclick="() => GenerateExample(category.Id)">
                                        @category.Name
                                    </button>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">System Prompt (Instructions)</label>
                        <textarea class="form-control"
                                  rows="6"
                                  placeholder="è¼¸å…¥ç³»çµ±æç¤ºè©ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ç¿»è­¯åŠ©æ‰‹..."
                                  @bind="testCase.SystemPrompt"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸¬è©¦å•é¡Œ</label>
                        <textarea class="form-control"
                                  rows="3"
                                  placeholder="è¼¸å…¥è¦æ¸¬è©¦çš„å•é¡Œ..."
                                  @bind="testCase.Question"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é æœŸç­”æ¡ˆ</label>
                        <textarea class="form-control"
                                  rows="3"
                                  placeholder="è¼¸å…¥é æœŸçš„ç­”æ¡ˆï¼ˆç”¨æ–¼è©•ä¼°æ­£ç¢ºæ€§ï¼‰..."
                                  @bind="testCase.ExpectedAnswer"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            æ¯è¼ªåŸ·è¡Œæ¬¡æ•¸: <span class="range-value">@testCase.ExecutionCount</span>
                        </label>
                        <div class="range-container">
                            <input type="range"
                                   class="form-range"
                                   min="1"
                                   max="10"
                                   @bind="testCase.ExecutionCount" />
                        </div>
                        <p class="range-hint">æ¯è¼ªåŸ·è¡Œå¤šæ¬¡ä»¥æ¸¬è©¦ç©©å®šæ€§ (å»ºè­° 3-5 æ¬¡)</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Temperature: <span class="range-value @GetTemperatureClass(testCase.Temperature)">@testCase.Temperature.ToString("0.0")</span>
                            <span class="temp-label">@GetTemperatureLabel(testCase.Temperature)</span>
                        </label>
                        <div class="range-container">
                            <input type="range"
                                   class="form-range"
                                   min="0"
                                   max="2"
                                   step="0.1"
                                   @bind="testCase.Temperature" />
                        </div>
                        <p class="range-hint">0 = ç©©å®šç¢ºå®š | 0.7 = æ¨™æº– | 1.5+ = é«˜å‰µæ„</p>
                    </div>

                    <!-- ä¸€èˆ¬æ¸¬è©¦æŒ‰éˆ• -->
                    <button class="btn-execute"
                            @onclick="ExecuteTestAsync"
                            disabled="@isExecuting">
                        @if (isExecuting && !isSmartMode)
                        {
                            <span class="spinner"></span>
                            <span>åŸ·è¡Œä¸­... (@completedCount/@testCase.ExecutionCount)</span>
                        }
                        else
                        {
                            <span>â–¶ï¸</span>
                            <span>é–‹å§‹æ¸¬è©¦</span>
                        }
                    </button>

                    <!-- æ™ºæ…§ä¿®æ­£æ¨¡å¼ -->
                    <div class="smart-mode-section">
                        <div class="smart-mode-header">
                            <span>ğŸ”„</span>
                            <span>æ™ºæ…§ä¿®æ­£æ¨¡å¼</span>
                        </div>
                        <div class="smart-mode-config">
                            <div class="input-row">
                                <label class="form-label">å„ªåŒ–è¼ªæ•¸:</label>
                                <input type="number"
                                       class="form-control form-control-sm"
                                       style="width: 80px;"
                                       min="1"
                                       max="20"
                                       @bind="smartRounds" />
                            </div>
                            <div class="input-row">
                                <label class="form-label">ç›®æ¨™åˆ†æ•¸:</label>
                                <input type="number"
                                       class="form-control form-control-sm"
                                       style="width: 80px;"
                                       min="50"
                                       max="100"
                                       @bind="targetScore" />
                                <label class="checkbox-label">
                                    <input type="checkbox" @bind="autoStopOnTarget" />
                                    <span>é”æ¨™å³åœ</span>
                                </label>
                            </div>
                            <p class="range-hint">ç©©å®šæ€§å’Œæ­£ç¢ºæ€§éƒ½é”åˆ°ç›®æ¨™åˆ†æ•¸æ™‚è‡ªå‹•åœæ­¢</p>
                        </div>
                        <button class="btn-smart"
                                @onclick="ExecuteSmartModeAsync"
                                disabled="@isExecuting">
                            @if (isExecuting && isSmartMode)
                            {
                                <span class="spinner"></span>
                                <span>æ™ºæ…§ä¿®æ­£ä¸­... ç¬¬ @currentRound/@smartRounds è¼ª</span>
                            }
                            else
                            {
                                <span>ğŸš€</span>
                                <span>å•Ÿå‹•æ™ºæ…§ä¿®æ­£</span>
                            }
                        </button>
                        @if (stoppedEarly)
                        {
                            <div class="early-stop-notice">
                                âœ… å·²æ–¼ç¬¬ @currentRound è¼ªé”åˆ°ç›®æ¨™åˆ†æ•¸ (@targetScore)ï¼Œæå‰åœæ­¢
                            </div>
                        }
                    </div>

                    <!-- å¼•å°æ¨¡å¼ -->
                    <div class="guided-mode-section">
                        <div class="guided-mode-header">
                            <span>ğŸ¯</span>
                            <span>å¼•å°æ¨¡å¼</span>
                            <span class="mode-badge">äººæ©Ÿå”ä½œ</span>
                        </div>
                        <p class="range-hint">æ¯è¼ªæš«åœè®“æ‚¨é¸æ“‡åå¥½çš„å›ç­”é¢¨æ ¼ï¼Œå†ç¹¼çºŒå„ªåŒ–</p>
                        <button class="btn-guided"
                                @onclick="ExecuteGuidedModeAsync"
                                disabled="@(isExecuting || waitingForFeedback)">
                            @if (isExecuting && isGuidedMode && !waitingForFeedback)
                            {
                                <span class="spinner"></span>
                                <span>åŸ·è¡Œä¸­... ç¬¬ @guidedRound è¼ª</span>
                            }
                            else if (waitingForFeedback)
                            {
                                <span>â¸ï¸</span>
                                <span>ç­‰å¾…æ‚¨çš„é¸æ“‡...</span>
                            }
                            else
                            {
                                <span>ğŸ¯</span>
                                <span>å•Ÿå‹•å¼•å°æ¨¡å¼</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´: çµæœå€åŸŸ -->
        <div>
            @if (waitingForFeedback && differenceAnalysis != null)
            {
                <!-- å¼•å°æ¨¡å¼åé¥‹å€ -->
                <div class="test-card guided-feedback-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(147, 51, 234, 0.3) 100%);">
                        <h2 class="card-title">
                            <span>ğŸ¯</span>
                            å¼•å°æ¨¡å¼ - ç¬¬ @guidedRound è¼ª
                        </h2>
                        <span class="waiting-badge">ç­‰å¾…æ‚¨çš„é¸æ“‡</span>
                    </div>
                    <div class="card-body">
                        <p class="feedback-summary">@differenceAnalysis.Summary</p>
                        
                        <div class="clusters-grid">
                            @foreach (var cluster in differenceAnalysis.Clusters)
                            {
                                <div class="cluster-card @(userFeedback.SelectedCluster == cluster.ClusterName ? "selected" : "")"
                                     @onclick="() => SelectCluster(cluster.ClusterName)">
                                    <div class="cluster-header">
                                        <input type="radio" 
                                               name="cluster-select"
                                               checked="@(userFeedback.SelectedCluster == cluster.ClusterName)" />
                                        <span class="cluster-name">@cluster.ClusterName</span>
                                    </div>
                                    <p class="cluster-description">@cluster.Description</p>
                                    @if (!string.IsNullOrEmpty(cluster.PreviewContent))
                                    {
                                        <div class="cluster-preview">@cluster.PreviewContent</div>
                                    }
                                    <div class="cluster-indices">
                                        å›ç­” @string.Join(", ", cluster.ResponseIndices)
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="feedback-divider">
                            <span>æˆ–</span>
                        </div>

                        <div class="custom-feedback-section">
                            <label class="form-label">è‡ªè¨‚æ–¹å‘ï¼š</label>
                            <input type="text" 
                                   class="form-control"
                                   placeholder="ä¾‹å¦‚ï¼šæ›´æ­£å¼ã€åŠ è¡¨æƒ…ç¬¦è™Ÿã€ç”¨ç¹é«”ä¸­æ–‡..."
                                   @bind="userFeedback.CustomFeedback"
                                   @onfocus="() => userFeedback.SelectedCluster = null" />
                        </div>

                        @if (differenceAnalysis.SuggestedDirections.Count > 0)
                        {
                            <div class="suggested-directions">
                                <span class="directions-label">ğŸ’¡ AI å»ºè­°ï¼š</span>
                                @foreach (var direction in differenceAnalysis.SuggestedDirections)
                                {
                                    <span class="direction-chip" @onclick="() => ApplySuggestion(direction)">
                                        @direction
                                    </span>
                                }
                            </div>
                        }

                        <div class="feedback-actions">
                            <button class="btn-continue" 
                                    @onclick="ContinueGuidedModeAsync"
                                    disabled="@(!userFeedback.HasFeedback || isOptimizing)">
                                @if (isOptimizing)
                                {
                                    <span class="spinner"></span>
                                    <span>å„ªåŒ–ä¸­...</span>
                                }
                                else
                                {
                                    <span>ğŸš€</span>
                                    <span>ç¹¼çºŒä¸‹ä¸€è¼ª</span>
                                }
                            </button>
                            <button class="btn-finish" @onclick="FinishGuidedMode">
                                <span>âœ“</span>
                                <span>æ»¿æ„ï¼ŒçµæŸ</span>
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (smartModeHistory.Count > 0)
            {
                <!-- æ™ºæ…§ä¿®æ­£æ­·å² -->
                <div class="test-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(251, 146, 60, 0.2) 100%);">
                        <h2 class="card-title">
                            <span>ğŸ“ˆ</span>
                            æ™ºæ…§ä¿®æ­£æ­·å² (@smartModeHistory.Count è¼ª)
                        </h2>
                        @if (performanceMetrics != null)
                        {
                            <span class="perf-badge">âˆ± @performanceMetrics.TotalTimeMs ms</span>
                        }
                    </div>
                    <div class="card-body">
                        @if (performanceMetrics != null)
                        {
                            <div class="perf-metrics">
                                <div class="perf-item">
                                    <span class="perf-label">ç¸½è€—æ™‚</span>
                                    <span class="perf-value">@performanceMetrics.TotalTimeMs ms</span>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-label">å¹³å‡æ¯è¼ª</span>
                                    <span class="perf-value">@performanceMetrics.AvgRoundTimeMs ms</span>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-label">API å‘¼å«</span>
                                    <span class="perf-value">@performanceMetrics.TotalApiCalls æ¬¡</span>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-label">å¹³å‡éŸ¿æ‡‰</span>
                                    <span class="perf-value">@performanceMetrics.AvgApiTimeMs ms</span>
                                </div>
                            </div>
                        }
                        <div class="history-timeline">
                            @foreach (var (round, result, metrics) in smartModeHistory.Select((r, i) => (i + 1, r, roundMetrics.Count > i ? roundMetrics[i] : null)))
                            {
                                <div class="history-item">
                                    <div class="history-round">ç¬¬ @round è¼ª</div>
                                    <div class="history-scores">
                                        <span class="history-score @GetScoreClass(result.StabilityScore)">
                                            ç©©å®š: @result.StabilityScore
                                        </span>
                                        <span class="history-score @GetScoreClass(result.CorrectnessScore)">
                                            æ­£ç¢º: @result.CorrectnessScore
                                        </span>
                                        @if (metrics != null)
                                        {
                                            <span class="history-time">@metrics.RoundTimeMs ms</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        @if (smartModeHistory.Count >= 2)
                        {
                            var first = smartModeHistory.First();
                            var last = smartModeHistory.Last();
                            var stabilityChange = last.StabilityScore - first.StabilityScore;
                            var correctnessChange = last.CorrectnessScore - first.CorrectnessScore;
                            <div class="history-summary">
                                <span>ç¸½è®ŠåŒ–:</span>
                                <span class="@(stabilityChange >= 0 ? "text-success" : "text-danger")">
                                    ç©©å®šæ€§ @(stabilityChange >= 0 ? "+" : "")@stabilityChange
                                </span>
                                <span class="@(correctnessChange >= 0 ? "text-success" : "text-danger")">
                                    æ­£ç¢ºæ€§ @(correctnessChange >= 0 ? "+" : "")@correctnessChange
                                </span>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (testResult != null)
            {
                <!-- è©•åˆ†å¡ç‰‡ -->
                <div class="test-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header card-header-success">
                        <h2 class="card-title">
                            <span>ğŸ“Š</span>
                            è©•ä¼°çµæœ
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="score-grid">
                            <div class="score-item">
                                <div class="score-value @GetScoreClass(testResult.StabilityScore)">
                                    @testResult.StabilityScore
                                </div>
                                <div class="score-label">ç©©å®šæ€§</div>
                                <div class="score-bar">
                                    <div class="score-bar-fill @GetScoreClass(testResult.StabilityScore)"
                                         style="width: @(testResult.StabilityScore)%"></div>
                                </div>
                            </div>
                            <div class="score-item">
                                <div class="score-value @GetScoreClass(testResult.CorrectnessScore)">
                                    @testResult.CorrectnessScore
                                </div>
                                <div class="score-label">æ­£ç¢ºæ€§</div>
                                <div class="score-bar">
                                    <div class="score-bar-fill @GetScoreClass(testResult.CorrectnessScore)"
                                         style="width: @(testResult.CorrectnessScore)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å„ªåŒ–å»ºè­° -->
                @if (testResult.Suggestions.Count > 0)
                {
                    <div class="test-card" style="margin-bottom: 1.5rem;">
                        <div class="card-header card-header-warning">
                            <h2 class="card-title">
                                <span>ğŸ’¡</span>
                                å„ªåŒ–å»ºè­°
                            </h2>
                            @if (!string.IsNullOrEmpty(testResult.OptimizedPrompt))
                            {
                                <button class="btn-accept" @onclick="AcceptSuggestions">
                                    âœ“ ä¸€éµæ¥å—å»ºè­°
                                </button>
                            }
                        </div>
                        <div class="card-body">
                            <ul class="suggestions-list">
                                @foreach (var suggestion in testResult.Suggestions)
                                {
                                    <li class="suggestion-item">@suggestion</li>
                                }
                            </ul>
                            @if (!string.IsNullOrEmpty(testResult.OptimizedPrompt))
                            {
                                <div class="optimized-prompt">
                                    <div class="optimized-label">å»ºè­°çš„å„ªåŒ–å¾Œ Promptï¼š</div>
                                    <div class="report-content">@testResult.OptimizedPrompt</div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- è©³ç´°å ±å‘Š -->
                <div class="test-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header card-header-info">
                        <h2 class="card-title">
                            <span>ğŸ“„</span>
                            è©³ç´°è©•ä¼°å ±å‘Š
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="report-content">@testResult.EvaluationReport</div>
                    </div>
                </div>

                <!-- å„æ¬¡åŸ·è¡Œçµæœ -->
                <div class="test-card">
                    <div class="card-header" style="background: rgba(0,0,0,0.3);">
                        <h2 class="card-title">
                            <span>ğŸ“‹</span>
                            å„æ¬¡åŸ·è¡Œçµæœ
                        </h2>
                    </div>
                    <div class="accordion-container">
                        @foreach (var response in testResult.Responses)
                        {
                            var collapseId = $"response-{response.ExecutionIndex}";
                            <div class="accordion-item">
                                <div class="accordion-header" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                                    <span class="status-badge @(response.IsSuccess ? "success" : "error")">
                                        @(response.IsSuccess ? "æˆåŠŸ" : "å¤±æ•—")
                                    </span>
                                    <span style="margin-left: 0.75rem; flex: 1;">ç¬¬ @response.ExecutionIndex æ¬¡åŸ·è¡Œ</span>
                                    <span style="color: #888; font-size: 0.85rem;">@response.ExecutionTimeMs ms</span>
                                </div>
                                <div id="@collapseId" class="collapse">
                                    <div class="accordion-content">
                                        @if (response.IsSuccess)
                                        {
                                            <div class="response-content">@response.Content</div>
                                        }
                                        else
                                        {
                                            <div style="color: #ef4444;">@response.ErrorMessage</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!isExecuting)
            {
                <!-- ç©ºç‹€æ…‹ -->
                <div class="test-card">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“¥</div>
                        <h3 class="empty-title">å°šç„¡æ¸¬è©¦çµæœ</h3>
                        <p class="empty-hint">
                            å¡«å¯«å·¦å´çš„æ¸¬è©¦é…ç½®ï¼Œç„¶å¾Œé»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€æŒ‰éˆ•<br />
                            ğŸ’¡ æç¤ºï¼šä½¿ç”¨ã€Œæ™ºæ…§ä¿®æ­£æ¨¡å¼ã€è‡ªå‹•è¿­ä»£å„ªåŒ– Prompt
                        </p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private TestCase testCase = new();
    private TestResult? testResult;
    private bool isExecuting;
    private int completedCount;
    
    // ç¯„ä¾‹ç”Ÿæˆ
    private bool isGeneratingExample;
    
    // æ™ºæ…§ä¿®æ­£æ¨¡å¼
    private bool isSmartMode;
    private int smartRounds = 3;
    private int currentRound;
    private List<TestResult> smartModeHistory = [];
    
    // ç›®æ¨™åˆ†æ•¸è¨­å®š
    private int targetScore = 100;
    private bool autoStopOnTarget = true;
    private bool stoppedEarly;
    
    // æ•ˆèƒ½ç›£æ§
    private PerformanceMetrics? performanceMetrics;
    private List<RoundMetrics> roundMetrics = [];
    
    // ç”¨æ–¼å–æ¶ˆéåŒæ­¥æ“ä½œï¼Œé˜²æ­¢å…ƒä»¶éŠ·æ¯€å¾Œç¹¼çºŒåŸ·è¡Œ
    private CancellationTokenSource? _cts;

    // å¼•å°æ¨¡å¼
    private bool isGuidedMode;
    private bool waitingForFeedback;
    private bool isOptimizing;
    private int guidedRound;
    private DifferenceAnalysis? differenceAnalysis;
    private UserFeedback userFeedback = new();
    private List<AgentResponse> currentResponses = [];
    private List<(int Round, string Feedback)> guidedHistory = [];

    // æ•ˆèƒ½ç›£æ§æ¨¡å‹
    private class PerformanceMetrics
    {
        public long TotalTimeMs { get; set; }
        public long AvgRoundTimeMs { get; set; }
        public int TotalApiCalls { get; set; }
        public long AvgApiTimeMs { get; set; }
    }
    
    private class RoundMetrics
    {
        public int Round { get; set; }
        public long RoundTimeMs { get; set; }
        public long AgentTimeMs { get; set; }
        public long EvalTimeMs { get; set; }
    }


    private async Task GenerateExample(string categoryId)
    {
        isGeneratingExample = true;
        StateHasChanged();

        try
        {
            var example = await ExampleGenerator.GenerateExampleAsync(categoryId);
            testCase.SystemPrompt = example.SystemPrompt;
            testCase.Question = example.Question;
            testCase.ExpectedAnswer = example.ExpectedAnswer;
            testResult = null;
            smartModeHistory.Clear();
            roundMetrics.Clear();
            performanceMetrics = null;
        }
        catch (Exception ex)
        {
            // å¦‚æœç”Ÿæˆå¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤
            testCase.SystemPrompt = $"ç¯„ä¾‹ç”Ÿæˆå¤±æ•—ï¼š{ex.Message}";
            testCase.Question = "";
            testCase.ExpectedAnswer = "";
        }
        finally
        {
            isGeneratingExample = false;
            StateHasChanged();
        }
    }

    private void AcceptSuggestions()
    {
        if (testResult?.OptimizedPrompt != null)
        {
            testCase.SystemPrompt = testResult.OptimizedPrompt;
            StateHasChanged();
        }
    }

    private async Task ExecuteTestAsync()
    {
        if (string.IsNullOrWhiteSpace(testCase.SystemPrompt) ||
            string.IsNullOrWhiteSpace(testCase.Question))
        {
            return;
        }

        // å–æ¶ˆä¹‹å‰çš„æ“ä½œä¸¦å»ºç«‹æ–°çš„ CancellationTokenSource
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        isExecuting = true;
        isSmartMode = false;
        completedCount = 0;
        testResult = null;
        StateHasChanged();

        try
        {
            var responses = await AgentService.ExecuteParallelAsync(testCase, token);
            completedCount = responses.Count;
            StateHasChanged();

            testResult = await EvaluationService.EvaluateResultsAsync(testCase, responses, token);
        }
        catch (OperationCanceledException)
        {
            // æ“ä½œå·²å–æ¶ˆï¼Œæ­£å¸¸æƒ…æ³
        }
        catch (Exception ex)
        {
            testResult = new TestResult
            {
                TestCaseId = testCase.Id,
                EvaluationReport = $"åŸ·è¡Œå¤±æ•—: {ex.Message}",
                Suggestions = ["è«‹æª¢æŸ¥ Azure OpenAI é€£ç·šè¨­å®šæ˜¯å¦æ­£ç¢º"]
            };
        }
        finally
        {
            isExecuting = false;
            StateHasChanged();
        }
    }

    private async Task ExecuteSmartModeAsync()
    {
        if (string.IsNullOrWhiteSpace(testCase.SystemPrompt) ||
            string.IsNullOrWhiteSpace(testCase.Question))
        {
            return;
        }

        // é™åˆ¶è¼ªæ•¸å’Œç›®æ¨™åˆ†æ•¸ç¯„åœ
        smartRounds = Math.Clamp(smartRounds, 1, 20);
        targetScore = Math.Clamp(targetScore, 50, 100);

        // å–æ¶ˆä¹‹å‰çš„æ“ä½œä¸¦å»ºç«‹æ–°çš„ CancellationTokenSource
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        isExecuting = true;
        isSmartMode = true;
        currentRound = 0;
        stoppedEarly = false;
        smartModeHistory.Clear();
        roundMetrics.Clear();
        performanceMetrics = null;
        testResult = null;
        StateHasChanged();

        var totalStopwatch = System.Diagnostics.Stopwatch.StartNew();
        long totalAgentTime = 0;
        long totalEvalTime = 0;
        int totalApiCalls = 0;
        
        // è¨˜éŒ„æœ€ä½³ Prompt å’Œåˆ†æ•¸
        string bestPrompt = testCase.SystemPrompt;
        int bestScore = 0;
        int consecutiveDeclines = 0;

        try
        {
            for (int round = 1; round <= smartRounds; round++)
            {
                token.ThrowIfCancellationRequested();
                
                var roundStopwatch = System.Diagnostics.Stopwatch.StartNew();
                currentRound = round;
                completedCount = 0;
                StateHasChanged();

                // åŸ·è¡Œæ¸¬è©¦
                var agentStopwatch = System.Diagnostics.Stopwatch.StartNew();
                var responses = await AgentService.ExecuteParallelAsync(testCase, token);
                agentStopwatch.Stop();
                totalAgentTime += agentStopwatch.ElapsedMilliseconds;
                totalApiCalls += responses.Count;
                
                completedCount = responses.Count;
                StateHasChanged();

                // è©•ä¼°çµæœ
                var evalStopwatch = System.Diagnostics.Stopwatch.StartNew();
                testResult = await EvaluationService.EvaluateResultsAsync(testCase, responses, token);
                evalStopwatch.Stop();
                totalEvalTime += evalStopwatch.ElapsedMilliseconds;
                totalApiCalls++; // è©•ä¼°ä¹Ÿæ˜¯ä¸€æ¬¡ API å‘¼å«
                
                roundStopwatch.Stop();
                
                // è¨˜éŒ„é€™è¼ªçš„æ•ˆèƒ½æ•¸æ“š
                roundMetrics.Add(new RoundMetrics
                {
                    Round = round,
                    RoundTimeMs = roundStopwatch.ElapsedMilliseconds,
                    AgentTimeMs = agentStopwatch.ElapsedMilliseconds,
                    EvalTimeMs = evalStopwatch.ElapsedMilliseconds
                });
                
                smartModeHistory.Add(testResult);
                
                // è¨ˆç®—ç•¶å‰ç¶œåˆåˆ†æ•¸ (å–å…©è€…è¼ƒä½çš„ï¼Œå› ç‚ºè¦é›™å„ª)
                int currentScore = Math.Min(testResult.StabilityScore, testResult.CorrectnessScore);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€ä½³åˆ†æ•¸
                if (currentScore > bestScore)
                {
                    bestScore = currentScore;
                    bestPrompt = testCase.SystemPrompt;
                    consecutiveDeclines = 0;
                }
                else if (currentScore < bestScore)
                {
                    consecutiveDeclines++;
                    
                    // å¦‚æœé€£çºŒä¸‹é™ 2 æ¬¡ï¼Œå›æ»¾åˆ°æœ€ä½³ Prompt
                    if (consecutiveDeclines >= 2)
                    {
                        testCase.SystemPrompt = bestPrompt;
                        consecutiveDeclines = 0;
                    }
                }
                
                StateHasChanged();

                // æª¢æŸ¥æ˜¯å¦é”åˆ°ç›®æ¨™åˆ†æ•¸
                if (autoStopOnTarget && 
                    testResult.StabilityScore >= targetScore && 
                    testResult.CorrectnessScore >= targetScore)
                {
                    stoppedEarly = true;
                    break;
                }

                // å¦‚æœæœ‰å„ªåŒ–å»ºè­°ä¸”ä¸æ˜¯æœ€å¾Œä¸€è¼ªï¼Œè‡ªå‹•æ¥å—
                if (round < smartRounds && !string.IsNullOrEmpty(testResult.OptimizedPrompt))
                {
                    testCase.SystemPrompt = testResult.OptimizedPrompt;
                    
                    // çŸ­æš«å»¶é²è®“ç”¨æˆ¶çœ‹åˆ°é€²åº¦
                    await Task.Delay(300, token);
                }
            }
            
            // æœ€å¾Œç¢ºä¿ä½¿ç”¨æœ€ä½³ Prompt
            testCase.SystemPrompt = bestPrompt;
            
            // è¨ˆç®—ç¸½é«”æ•ˆèƒ½æŒ‡æ¨™
            totalStopwatch.Stop();
            performanceMetrics = new PerformanceMetrics
            {
                TotalTimeMs = totalStopwatch.ElapsedMilliseconds,
                AvgRoundTimeMs = smartModeHistory.Count > 0 ? totalStopwatch.ElapsedMilliseconds / smartModeHistory.Count : 0,
                TotalApiCalls = totalApiCalls,
                AvgApiTimeMs = totalApiCalls > 0 ? (totalAgentTime + totalEvalTime) / totalApiCalls : 0
            };
        }
        catch (OperationCanceledException)
        {
            // æ“ä½œå·²å–æ¶ˆï¼Œæ­£å¸¸æƒ…æ³
        }
        catch (Exception ex)
        {
            testResult = new TestResult
            {
                TestCaseId = testCase.Id,
                EvaluationReport = $"æ™ºæ…§ä¿®æ­£å¤±æ•—: {ex.Message}",
                Suggestions = ["è«‹æª¢æŸ¥ Azure OpenAI é€£ç·šè¨­å®šæ˜¯å¦æ­£ç¢º"]
            };
        }
        finally
        {
            isExecuting = false;
            isSmartMode = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }

    private static string GetScoreClass(int score) => score switch
    {
        >= 80 => "success",
        >= 60 => "warning",
        _ => "danger"
    };

    private static string GetTemperatureClass(float temp) => temp switch
    {
        <= 0.3f => "temp-stable",
        <= 0.8f => "temp-standard",
        _ => "temp-creative"
    };

    private static string GetTemperatureLabel(float temp) => temp switch
    {
        <= 0.3f => "ğŸ¯ ç©©å®š",
        <= 0.8f => "âš–ï¸ æ¨™æº–",
        <= 1.2f => "âœ¨ å‰µæ„",
        _ => "ğŸ”¥ é«˜å‰µæ„"
    };

    #region å¼•å°æ¨¡å¼ (Guided Mode)

    private async Task ExecuteGuidedModeAsync()
    {
        if (string.IsNullOrWhiteSpace(testCase.SystemPrompt) ||
            string.IsNullOrWhiteSpace(testCase.Question))
        {
            return;
        }

        // å–æ¶ˆä¹‹å‰çš„æ“ä½œä¸¦å»ºç«‹æ–°çš„ CancellationTokenSource
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        // åˆå§‹åŒ–å¼•å°æ¨¡å¼ç‹€æ…‹
        isExecuting = true;
        isGuidedMode = true;
        isSmartMode = false;
        waitingForFeedback = false;
        guidedRound = 1;
        guidedHistory.Clear();
        differenceAnalysis = null;
        userFeedback = new UserFeedback();
        testResult = null;
        smartModeHistory.Clear();
        StateHasChanged();

        try
        {
            await ExecuteGuidedRoundAsync(token);
        }
        catch (OperationCanceledException)
        {
            // æ“ä½œå·²å–æ¶ˆ
        }
        catch (Exception ex)
        {
            testResult = new TestResult
            {
                TestCaseId = testCase.Id,
                EvaluationReport = $"å¼•å°æ¨¡å¼å¤±æ•—: {ex.Message}",
                Suggestions = ["è«‹æª¢æŸ¥ Azure OpenAI é€£ç·šè¨­å®šæ˜¯å¦æ­£ç¢º"]
            };
            isExecuting = false;
            isGuidedMode = false;
            StateHasChanged();
        }
    }

    private async Task ExecuteGuidedRoundAsync(CancellationToken token)
    {
        completedCount = 0;
        StateHasChanged();

        // åŸ·è¡Œæ¸¬è©¦
        currentResponses = await AgentService.ExecuteParallelAsync(testCase, token);
        completedCount = currentResponses.Count;

        // è©•ä¼°çµæœ
        testResult = await EvaluationService.EvaluateResultsAsync(testCase, currentResponses, token);
        StateHasChanged();

        // åˆ†æå›ç­”å·®ç•°
        differenceAnalysis = await EvaluationService.AnalyzeResponseDifferencesAsync(testCase, currentResponses, token);
        
        // é€²å…¥ç­‰å¾…åé¥‹ç‹€æ…‹
        waitingForFeedback = true;
        isExecuting = false;
        userFeedback = new UserFeedback();
        StateHasChanged();
    }

    private async Task ContinueGuidedModeAsync()
    {
        if (!userFeedback.HasFeedback) return;

        _cts ??= new CancellationTokenSource();
        var token = _cts.Token;

        isOptimizing = true;
        StateHasChanged();

        try
        {
            // è¨˜éŒ„é€™è¼ªçš„åé¥‹
            var feedbackText = userFeedback.SelectedCluster ?? userFeedback.CustomFeedback ?? "";
            guidedHistory.Add((guidedRound, feedbackText));

            // æ ¹æ“šåé¥‹å„ªåŒ– Prompt
            var optimizedPrompt = await EvaluationService.OptimizeWithFeedbackAsync(
                testCase, currentResponses, userFeedback, token);
            
            testCase.SystemPrompt = optimizedPrompt;

            // é€²å…¥ä¸‹ä¸€è¼ª
            isOptimizing = false;
            waitingForFeedback = false;
            isExecuting = true;
            guidedRound++;
            StateHasChanged();

            await ExecuteGuidedRoundAsync(token);
        }
        catch (OperationCanceledException)
        {
            // æ“ä½œå·²å–æ¶ˆ
        }
        catch (Exception ex)
        {
            testResult = new TestResult
            {
                TestCaseId = testCase.Id,
                EvaluationReport = $"å„ªåŒ–å¤±æ•—: {ex.Message}",
                Suggestions = ["è«‹é‡è©¦"]
            };
        }
        finally
        {
            isOptimizing = false;
            StateHasChanged();
        }
    }

    private void FinishGuidedMode()
    {
        waitingForFeedback = false;
        isGuidedMode = false;
        isExecuting = false;
        differenceAnalysis = null;
        StateHasChanged();
    }

    private void SelectCluster(string clusterName)
    {
        userFeedback.SelectedCluster = clusterName;
        userFeedback.CustomFeedback = null;
        StateHasChanged();
    }

    private void ApplySuggestion(string suggestion)
    {
        userFeedback.SelectedCluster = null;
        userFeedback.CustomFeedback = suggestion;
        StateHasChanged();
    }

    #endregion
}
